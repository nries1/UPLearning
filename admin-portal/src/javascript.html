<script>
      window.addEventListener('load', welcome);
      var allEventData;
      var filteredEvents = [];
      var events=[];
      var archiveEventData;
      var participantEmails = [];
      var participantDetails;
      var usingFeedback = true;
      var instance;
      var bcos = [];
      var userPermissions;
      var dms = [];
      var sySelected = "";
     
function hideTab(hideTabId,revealTabId) {
  document.getElementById(hideTabId).style.display='none';
  document.getElementById(revealTabId).style.display='';
}

function welcome() {
  google.script.run.withSuccessHandler(function(msg) {
    userPermissions = msg
    if (userPermissions === "dm") document.getElementById("main-dropdown-menu").appendChild(htmlElement({tag: "A", className: "dropdown-item", href: "https://script.google.com/a/macros/strongschools.nyc/s/AKfycbzQHjynpgMQaOH6nHh-u3DygHPgiBbuKq_9Di5-BQLdxTGS8dI/exec?base=true", target: "_blank", innerHTML: "APLSS"}));
    console.log("Running as "+userPermissions);
  }).getUserPermissions()
  console.log("showing modal");
  $(function () {
    $('[data-toggle="popover"]').popover()
  })
  $("#modal-vertical").modal({show: true});
  displaySys();
}

function selectBco(el) {
  if (el.className.indexOf("active")===-1) {
    el.className="list-group-item active";
    if (bcos.indexOf(el.id)===-1) {
      bcos.push(el.id)
    }
  } else {
    el.className="list-group-item";
    bcos.splice(bcos.indexOf(el.id),1);
  }
  if (bcos.length>2) {
    document.getElementById("modal-failure").style.display = "";
    document.getElementById("modal-failure").innerHTML = "Heads up! You are selecting a lot of data. It could take a minute or so to retrieve all this information.";
  } else {
    document.getElementById("modal-failure").style.display = "none";
  }
}
      
function fetchInstanceDetails() {
  var sy = document.getElementById("sy-select").value;
  sySelected = sy;
  var withSuccess = google.script.run.withSuccessHandler(renderEvents);
  var withFailure = withSuccess.withFailureHandler(function(error) {
     console.log("error handler for fetchParticipantDetails message: "+error);
     document.getElementById("main-spinner").innerHTML = "Something went wrong...";
   });
  withFailure.getInstanceDetails(bcos,sy);
  document.getElementById("event-details").innerHTML = "";
  document.getElementById("main-spinner").style.display = "";
  document.getElementById("main-spinner-msg").innerHTML = "Getting data for "+bcos.length+" instance(s)"; 
}

function initActivateEvent(eventid) {
  var event =  allEventData.events.filter(function(e) {return e.id===eventid})[0];
  document.getElementById("modal-title").innerHTML = "Activate an Event";
  document.getElementById("modal-body-msg").style.display = "none";
  document.getElementById("modal-spinner").style.display = "";
  document.getElementById("modal-spinner-msg").style.display = "";
  document.getElementById("modal-spinner-msg").innerHTML = "Activating event id "+eventid;
  var withSuccess = google.script.run.withSuccessHandler(function(msg) {
    document.getElementById("modal-spinner").style.display = "none";
    if (msg.success) {
      document.getElementById("modal-success").style.display = "";
      document.getElementById("modal-success").innerHTML = msg.msg;
      event.status = "active";
      document.getElementById("status-"+eventid).innerHTML = "Status: active";
    } else {
      document.getElementById("modal-failure").style.display = "";
      document.getElementById("modal-failure").innerHTML = msg.msg;    
    }
  });
  var withFailure = withSuccess.withFailureHandler(function(error) {
    document.getElementById("modal-spinner").style.display = "none";
    document.getElementById("modal-failure").style.display = "";
    document.getElementById("modal-failure").innerHTML = error;
  });
  withFailure.activateEvent(eventid,event.instance);  
}

function initArchiveEvent(eventid) {
  document.getElementById("modal-vertical").style.display="";
  document.getElementById("modal-title").innerHTML = "Archive Event";
  document.getElementById("modal-footer").style.display = "none";
  document.getElementById("modal-success").style.display = "none";
  document.getElementById("modal-failure").style.display = "none";
  document.getElementById("modal-body-msg").style.display = "";
  document.getElementById("modal-body").style.display = "";
  document.getElementById("modal-body-msg").innerHTML =
  '<label for="sy-select">Select the SY that this event belongs to:</label>\
  <select class="form-control" id="sy-select" name="sy-select"></select>\
  <div style="width: 100%; display: flex; justify-content: center; margin-top: 25px;">\
  <button class="btn btn-outline-primary btn-sm" onclick="archive(\''+eventid+'\')">Archive</button>\
  </div>';
  displaySys();
}

function archive(eventid) {
  console.log("archiving "+eventid);
  var event =  allEventData.events.filter(function(e) {return e.id===eventid})[0];
  var sy = document.getElementById("sy-select").value;
  document.getElementById("modal-title").innerHTML = "Archive an Event";
  document.getElementById("modal-body-msg").style.display = "none";
  document.getElementById("modal-spinner").style.display = "";
  document.getElementById("modal-spinner-msg").style.display = "";
  document.getElementById("modal-spinner-msg").innerHTML = "Archiving event id "+eventid;
  var withSuccess = google.script.run.withSuccessHandler(function(msg) {
    document.getElementById("modal-spinner").style.display = "none";
    if (msg.success) {
      document.getElementById("modal-success").style.display = "";
      document.getElementById("modal-success").innerHTML = msg.msg;
      event.status = "archived";
      document.getElementById("status-"+eventid).innerHTML = "Status: archived";
    } else {
      document.getElementById("modal-failure").style.display = "";
      document.getElementById("modal-failure").innerHTML = msg.msg;    
    }
  });
  var withFailure = withSuccess.withFailureHandler(function(error) {
    document.getElementById("modal-spinner").style.display = "none";
    document.getElementById("modal-failure").style.display = "";
    document.getElementById("modal-failure").innerHTML = error;
  });
  withFailure.postToArchive(eventid,event.instance,sy);
}

function exportRegDetails() {
  var withSuccess = google.script.run.withSuccessHandler(function(msg) {
    if (!msg) {return}
    document.getElementById("modal-body").style.display = "";
    document.getElementById("modal-body-msg").style.display = "none";
    document.getElementById("modal-footer").style.display = "";
    document.getElementById("modal-spinner").style.display = "none";
    document.getElementById("modal-success").style.display = "";
    document.getElementById("modal-success").innerHTML = "<a target=_blank href='"+msg+"'>Here is your spreadsheet</a>";
  });
  var withFailure = withSuccess.withFailureHandler(function(error) {
    document.getElementById("modal-body").style.display = "";
    document.getElementById("modal-body-msg").style.display = "none";
    document.getElementById("modal-footer").style.display = "";
    document.getElementById("modal-spinner").style.display = "none";
    document.getElementById("modal-failure").style.display = "";
    document.getElementById("modal-failure").innerHTML = error;
  });
   var displayFilters = Object.keys(filters).reduce(function(arr, key) {
          if (key !== "currentFilters") {
            if (filters[key] === "" || filters[key].length === 0) {
              arr.push([key, "None"]);
            } else {
              arr.push([key, filters[key]]);
            }
          }
          return arr;
        }, []);
  if (document.getElementById("email it").checked) {
    if (document.getElementById("export-email-input").value==="") {
      alert("Enter your email address, or select generate report now."); return;
    } else {
      var email=document.getElementById("export-email-input").value;
      if (filteredEvents.length>0) {
        withFailure.createRegSsEmail(filteredEvents,bcos,email, displayFilters);
      } else {
        withFailure.createRegSsEmail(allEventData.events,bcos,email, displayFilters);
      }
    }
    document.getElementById("modal-body-msg").innerHTML = "Your report will be emailed to "+email;
  } else if (document.getElementById("generate now").checked) {
      if (filteredEvents.length>0) {
        withFailure.createRegSs(filteredEvents, bcos, displayFilters);
      } else {
        withFailure.createRegSs(allEventData.events, bcos, displayFilters);
      }
      document.getElementById("modal-footer").style.display = "none";
      document.getElementById("modal-spinner").style.display = "";
      document.getElementById("modal-spinner-msg").style.display = "";
      document.getElementById("modal-spinner-msg").innerHTML = "Generating a Spreadsheet using the filters you selected."
      document.getElementById("modal-body-msg").style.display = "none";
  }
}

function initRegExport() {
 if (!allEventData) {alert("There's no data to export right now."); return;}
  document.getElementById("modal-vertical").style.display="";
  document.getElementById("modal-title").innerHTML = "Export Event Details";
  document.getElementById("modal-footer").style.display = "none";
  document.getElementById("modal-success").style.display = "none";
  document.getElementById("modal-failure").style.display = "none";
  document.getElementById("modal-body-msg").style.display = "";
  document.getElementById("modal-body").style.display = "";
  document.getElementById("modal-body-msg").innerHTML =
  "<div class='form-group'>\
    <label for='generate now'>Generate Short Report Now</label>\
    <input type='radio' name='report-type' id='generate now'>\
  </div>\
  <div class='form-group'>\
    <label for='email it'>Email Long Report</label>\
    <input type='radio' name='report-type' id='email it' onclick='document.getElementById(\"export-email-input\").style.display=\"\"'>\
    <input type='email' class='form-control' id='export-email-input' style='display: none;' placeholder='Enter your email'>\
  </div>\
  <button type='button' class='btn btn-primary btn-sm' onclick='exportRegDetails()'>Generate Report</button>"  
}

function renderEvents(eventsobj,filter) {
  var parsedEventsObj = JSON.parse(eventsobj);
  var events = parsedEventsObj.events;
  if (!dbns.all) {
    fetchDbns()
  }
  if (!filter) {
    allEventData=parsedEventsObj;
    if (!events || events.length===0) {
      document.getElementById("event-details").innerHTML = "You don't have any events to display";
      document.getElementById("main-spinner").style.display = "none";
      return;
    }
    var districtSelector = document.getElementById("districts");
    var districtAttendedSelector = document.getElementById("districts_attending");
    districtSelector.innerHTML="";
    districtAttendedSelector.innerHTML="";
    districtSelector.appendChild(htmlElement({tag: "OPTION", value: "", innerHTML: "All"}));
    districtAttendedSelector.appendChild(htmlElement({tag: "OPTION", value: "", innerHTML: "All"}));
    parsedEventsObj.districts.forEach(function(dist,index) {
        if (dist==="All Districts" || dist==="All Affinity Districts") {return}
        districtSelector.appendChild(htmlElement({tag: "OPTION", value: dist, innerHTML: dist}));
        districtSelector.dataset.rendered="true";
        districtAttendedSelector.appendChild(htmlElement({tag: "OPTION", value: dist, innerHTML: dist}));
        districtAttendedSelector.dataset.rendered="true";
      });
  }
  document.getElementById("data-summary").style.display = "flex";
  var allEvents = 0;
  var totalRegistered = 0;
  var totalAttended = 0;
  var attendanceRate = 0;
  var attendedOnce = 0;
  var regRate = 0;
  var ctleSent = 0;
  var totalSessions = 0;
  for (var i=0;i<events.length;i++) {
    allEvents++;
    totalSessions+=Number(events[i].countDates);
    if (events[i].attendanceInfo.attendanceTrackRate===1) {
      if (events[i].attendanceInfo.sessions_attended || events[i].attendanceInfo.sessions_attended===0) {
        totalAttended+=events[i].attendanceInfo.sessions_attended
      } else {
        console.log("event "+events[i].id+" sessions attended = "+events[i].attendanceInfo.sessions_attended+" attended= "+events[i].attendanceInfo.attended);
        totalAttended+=events[i].attendanceInfo.attended
      }
      regRate+=events[i].attendanceInfo.registered*events[i].countDates;
    }
    totalRegistered+=Number(events[i].currentRegs);
    if (events[i].attendanceInfo.attended1day) attendedOnce+=Number(events[i].attendanceInfo.attended1day);
    if (events[i].ctle_sent ** events[i].ctle_sent!=="" && events[i].ctle_sent!==0) ctleSent+= Number(events[i].ctle_sent);
    var newCard = card(events[i]);
    document.getElementById("event-details").appendChild(newCard);
  }
  document.getElementById("total-events").innerHTML=allEvents;
  document.getElementById("registered").innerHTML=totalRegistered;
  document.getElementById("attended").innerHTML=attendedOnce;
  document.getElementById("attn-rate").innerHTML=Math.round(Number(totalAttended/regRate)*100)+"%";
  document.getElementById("total-sessions").innerHTML=totalSessions
  document.getElementById("registered-sessions").innerHTML=regRate;
  document.getElementById("attended-sessions").innerHTML=totalAttended;
  document.getElementById("ctle-sent").innerHTML=ctleSent
  document.getElementById("main-spinner").style.display = "none";
  console.log("sessions registered: "+regRate+" sessions attended: "+totalAttended);
}

function card(event) {
  // parent element
  var card = htmlElement({tag: "DIV", className: "card text-center event-tile", style: "width: 75%; margin-bottom: 25px;", id: "event-card-"+event.id});
  // the header where the nav bar will go
  var cardHeader = htmlElement({"tag": "DIV", "className": "card-header", style: "display: flex; align-items: center; justify-content: space-between"});
  var navBar = htmlElement({"tag": "UL", "className": "nav nav-pills card-header-pills"});
  var dropDownLabel = htmlElement({tag: "A", className: "nav-link dropdown-toggle", "data-toggle": "dropdown", href: "#", innerHTML: "Menu", role: "button", "aria-expanded": "false", "aria-haspopup": "true", eventListener: {event: "click", "function": function(e) {e.preventDefault()} }});
  var linksDropDown = htmlElement({tag: "DIV", className: "dropdown-menu"});
  linksDropDown.appendChild(htmlElement({tag: "DIV", innerHTML: "Show Attendance Table", className: "dropdown-item", eventListener: {"event": "click", "function": function(e) {showDbnTable(e.target,event.id)}}}));
  linksDropDown.appendChild(htmlElement({tag: "A", className: "dropdown-item", href: event.feedback_link, innerHTML: "View Feedback", target: "_blank"}));
  linksDropDown.appendChild(htmlElement({tag: "A", className: "dropdown-item", href: event.session_notes_link, innerHTML: "View Session Notes", target: "_blank"}));
  if (userPermissions === "dm") {
    if (event.status === "active") {
      linksDropDown.appendChild(htmlElement({tag: "DIV", className: "dropdown-item", onclick: function () {initArchiveEvent(event.id)}, innerHTML: "Archive Event", target: "_blank", "data-toggle": "modal", "data-target": "#modal-vertical"}));
    } else if (sySelected === "current" && event.status === "archived") {
      linksDropDown.appendChild(htmlElement({tag: "DIV", className: "dropdown-item", onclick: function () {initActivateEvent(event.id)}, innerHTML: "Activate Event", target: "_blank", "data-toggle": "modal", "data-target": "#modal-vertical"}));
    }
  }
  navBar.appendChild(dropDownLabel);
  navBar.appendChild(linksDropDown);
  var statusIdBox = htmlElement({tag: "DIV", style: "display: flex; flex-direction: column; align-items: center; justify-content: space-between"});
    statusIdBox.appendChild(htmlElement({tag: "DIV", innerHTML: "ID: "+event.id}))
    statusIdBox.appendChild(htmlElement({tag: "DIV", innerHTML: "Status: "+event.status, id: "status-"+event.id}));
  cardHeader.appendChild(statusIdBox);
  cardHeader.appendChild(navBar);
  card.appendChild(cardHeader);
  // end nav items
  
  //the card body
  var cardBody = htmlElement({"tag": "DIV", "className": "card-body"});
  var title = htmlElement({"tag": "H5", "className": "card-title", "innerHTML": event.title});
  cardBody.appendChild(title);
  var attnSummaryDiv = htmlElement({tag: "DIV", style: "display: flex; width: 100%; justify-content: space-around; align-items: center;"});
  attnSummaryDiv.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>Registered: </b>"+event.currentRegs+"/"+event.max_regs}));
  attnSummaryDiv.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>Waitlist: </b>"+event.waitlist}));
  attnSummaryDiv.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>Feedback: </b>"+event.feedback}));
  if (event.attendanceInfo) {
    if (event.attendanceInfo.attendanceRate!==null && event.attendanceInfo.attendanceTrackRate===1) {
      attnSummaryDiv.appendChild(htmlElement({tag: "P", style: "margin-bottom: 1rem;",className: "card-text", innerHTML: "<b>Attendance Rate: </b>"+Math.round(Number(event.attendanceInfo.attendanceRate)*100)+"%" || "N/A"}));
    } else {
      attnSummaryDiv.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>AttendanceRate: </b>N/A"})); 
    }
  } else {
    attnSummaryDiv.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>AttendanceRate: </b>N/A"}));
  }
  cardBody.appendChild(attnSummaryDiv);
  cardBody.appendChild(htmlElement({tag: "DIV", id: "dbn-container-"+event.id, style: "display: none;"}));
    // more info  
    var moreInfo = htmlElement({tag: "DIV", id: "more-info-box-"+event.id, style: "display: none; flex-direction: column;"});
      moreInfo.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>Where: </b>"+event.location}));
      moreInfo.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>All Dates: </b>"+event.allDates}));
      moreInfo.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>Times: </b>"+event.times}))
      moreInfo.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>Districts: </b>"+event.districts}));
      moreInfo.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>Content: </b>"+event.content}));
      moreInfo.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>Audience: </b>"+event.audience}));
      moreInfo.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>Grade Band: </b>"+event.grade}));
      moreInfo.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>Funding: </b>"+event.funding}));
      moreInfo.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>Facilitators: </b>"+event.facilitators}));
      moreInfo.appendChild(htmlElement({tag: "P", className: "card-text", innerHTML: "<b>CTLE Eligible: </b>"+event.ctle_eligible}))
    cardBody.appendChild(moreInfo);
      var cardButtons = htmlElement({tag: "DIV", style: "display: flex; width: 100%; justify-content: space-around; align-items: center;"})
      //more info button
      cardButtons.appendChild(htmlElement({tag: "DIV", className: "btn btn-primary btn-sm", eventListener: {"event": "click", "function": function(e) {
         if (document.getElementById("more-info-box-"+event.id).style.display==="none") {
            document.getElementById("more-info-box-"+event.id).style.display="flex";
            e.target.innerHTML="Show Less";
          } else {
            document.getElementById("more-info-box-"+event.id).style.display="none";
            e.target.innerHTML="Show More";
          }
        }}, innerHTML: "Show More", style: "margin-top: 10px;"}));
    //end more info
    //cardButtons.appendChild(htmlElement({tag: "A", href: event.session_notes_link, target:"_blank", className: "btn btn-outline-primary btn-sm", innerHTML: "View Session Notes"}));
    //cardButtons.appendChild(htmlElement({tag: "A", href: event.feedback_link, target:"_blank", className: "btn btn-outline-primary btn-sm", innerHTML: "View Feedback"}))
   cardBody.appendChild(cardButtons);
   card.appendChild(cardBody);
  // end card body
  return card;
}
   
      function toggleFilters(canvas) {
        if (canvas.dataset.expanded==="false") {
          document.getElementById("filters-container").style.display="";
          canvas.dataset.expanded="true";
          canvas.style.transform="rotate(225deg)";
        } else {
          document.getElementById("filters-container").style.display="none";
          canvas.dataset.expanded="false";
          canvas.style.transform="rotate(45deg)";
        }
      }
      
      function fetchEventDetails() {
        document.getElementById("event-details").innerHTML = "";
        document.getElementById("suggestions-container").innerHTML = "";
        document.getElementById("archived-event-portal").innerHTML = "Archived Events";
        document.getElementById("event-portal").innerHTML = "Active Events";
        if (allEventData) {renderEventDetails(allEventData); return;}
        var withSuccess = google.script.run.withSuccessHandler(renderEventDetails);
        var withFailure = withSuccess.withFailureHandler(function(error) {
          console.log("error handler for fetchEventDetails message: "+error);
          document.getElementById("event-details").innerHTML = "Sorry, something went wrong.";
        });
        withFailure.getEventDetails(instance);
        showProgress(0,1500,document.getElementById("event-progress-bar"),document.getElementById("event-details"));
      }

      function notifyRegistrants(eventObj) {
        document.getElementById("modal-body-msg").style.display = "none";
        document.getElementById("modal-spinner").style.display=""
        document.getElementById("modal-title").innerHTML="Notifying Registrants";
        document.getElementById("modal-spinner-msg").innerHTML="Searching for registrants to notfiy. Please wait for confirmation."      
        var withSuccess = google.script.run.withSuccessHandler(function(confirmation) {
          document.getElementById("modal-spinner").style.display="none";
          document.getElementById("modal-success").style.display="";
          document.getElementById("modal-success").innerHTML=confirmation;
          document.getElementById("modal-footer").style.display="";
        });
        var withFailure = withSuccess.withFailureHandler(function(error) {
          document.getElementById("modal-spinner").style.display="none";
          document.getElementById("modal-failure").style.display="";
          document.getElementById("modal-failure").innerHTML=error;
          document.getElementById("modal-title").innerHTML="Error";
          document.getElementById("modal-footer").style.display="";
        });
        withFailure.emailRegistrants(eventObj,instance);
      }

      function initiateCancel(eventId) {
          document.getElementById("modal-title").innerHTML = "Canceling Event";
          document.getElementById("modal-footer").style.display = "none";
          document.getElementById("modal-spinner").style.display = "";
          document.getElementById("modal-spinner-msg").style.display = "";
          document.getElementById("modal-spinner-msg").innerHTML = "Canceling your event. Please wait for confirmation."
          document.getElementById("modal-body-msg").style.display = "none";
        var withSuccess = google.script.run.withSuccessHandler(function(eventobj) {
          document.getElementById("event-details").removeChild(document.getElementById("event-card-"+eventobj.eventId));
          document.getElementById("modal-body-msg").style.display = "";
          document.getElementById("modal-body-msg").innerHTML="<div class='alert alert-success' role='alert'>Your event was canceled.</div><p class='card-text'>Do you want to send an automated cancelation email to registrants now?</p><div style='width: 100%; display: flex; justify-content: space-around;'><button class='btn btn-primary' style='margin-right: 100px;' id='send-notification-button'>Send</button><button class='btn btn-secondary' data-dismiss='modal'>Don't Send</button></div>";
          document.getElementById("modal-spinner").style.display = "none";
          document.getElementById("modal-title").innerHTML = "Event Cancelled";
          document.getElementById("send-notification-button").addEventListener('click', function () {
            notifyRegistrants(eventobj);
          });
          document.getElementById("close-modal-button").style.display="";
        });
        var withFailure = withSuccess.withFailureHandler(function(error) {
          document.getElementById("modal-title").innerHTML = "Error";
          document.getElementById("modal-failure").style.display = "";
          document.getElementById("modal-failure").innerHTML=error;
          document.getElementById("modal-body-msg").style.display = "none";
          document.getElementById("close-modal-button").style.display="";
        });
        withFailure.cancelEvent(eventId,instance);
      }
      
      function restore() {
         document.getElementById('spinner-loader').style.visibility='visibile';
         document.getElementById('main-spinner').style.display='none';
         document.getElementById('event-details').style.visibility='visible';       
      }
      
      function verifyCancel(eventId) {
        document.getElementById("modal-vertical").style.display="";
        document.getElementById("modal-title").style.display="";
        document.getElementById("modal-title").innerHTML = "Cancel Event?";
        document.getElementById("modal-footer").style.display = "none";
        document.getElementById("modal-spinner").style.display = "none";
        document.getElementById("modal-spinner-msg").style.display = "none";
        document.getElementById("modal-body-msg").style.display = "";
        document.getElementById("modal-body-msg").innerHTML='This will delete all the sessions for this event. Are you sure you want to cancel all the sessions?<br><br>\
        <div style="display: flex; width: 100%; justify-content: space-around;"><button id="yes-cancel-button" type="button" class="btn btn-primary" onclick="initiateCancel(\''+eventId+'\')">Yes</button>\
        <button id="no-cancel-button" type="button" class="btn btn-secondary" data-dismiss="modal">No</button>\
        </div>';
        document.getElementById("close-modal-button").style.display="none";
      }
      
      
      var filters = {"division": "", "status": "", "title": "", "content": "", "districts": "", "date": "", "id": "", "districts_attending": "", "has_registrants": "", "ctle_eligible": "", "instance": "", "funding": "", "support_type": "", "audience": "", "grade": "", "dbn_attending": "",
                       "currentFilters": function() {
                                           let currentFilters = [];
                                           let keys = Object.keys(this);
                                           for (var i in keys) {
                                             if (this[keys[i]] !== "" && keys[i] !== "currentFilters") {
                                               currentFilters.push(keys[i]);
                                             }
                                           }
                                           return currentFilters;
                                          }
                     }
      
      
      function filterTable(input) {
        var events = allEventData.events;
        var table = document.getElementById("event-details");
        table.innerHTML = "";
        document.getElementById("main-spinner").style.display="";
        document.getElementById("main-spinner-msg").innerHTML = "filtering";
        if (input.id === "date" && input.value !== "") {
          //filters[input.id] = new Date(new Date(input.value).getTime()+24*60*60*1000).toString().slice(0,15)
          var inputDate = new Date(input.value);
          inputDate.setUTCHours(20);
          console.log(inputDate.toDateString());
          filters[input.id] = inputDate.toDateString();
        } else {
          filters[input.id] = input.value;
        }
        var currentFilters = filters.currentFilters();
        console.log(filters);
        var selectors = document.getElementById("instance").getElementsByTagName("OPTION");
        for (var s=0; s<selectors.length; s++) {console.log(selectors[s].selected)}
        if (currentFilters.length === 0) {
          filteredEvents=[];
          renderEvents(JSON.stringify({"districts": allEventData.districts, "events": events}),false);
          return;
        } else {
          filteredEvents=[];
          for (var x=0; x<events.length; x++) {
            if (currentFilters.reduce(function(hide,key) {  
                if (events[x][key]) {
                  if (key==="ctle_eligible") {
                    if (filters.ctle_eligible==="eligible") {
                      if (events[x][key].toString().indexOf("NOT") !==-1) hide++;
                    } else if (filters.ctle_eligible==="not eligible") {
                      if (events[x][key].toString().indexOf("NOT")===-1) {
                        hide++;
                      }                      
                    }
                  } else if (key==="instance") {
                    var selectors = document.getElementById("instance").getElementsByTagName("OPTION");
                    var selectedInstances = [];
                    for (var s=0; s<selectors.length; s++) {
                      if(selectors[s].selected) selectedInstances.push(selectors[s].value);
                    }
                    if (selectedInstances.indexOf(events[x].instance)===-1) hide++;
                  } else if ((key==="districts" && filters[key]==="All Community Districts") || (key==="districts" && filters[key]==="All HS Districts")) {
                    if (filters[key]==="All Community Districts") {
                      if (events[x].districts.split(",").reduce(function(count,dist) {
                         if (dist.toString().indexOf("HS")===-1 && dist.toString().indexOf("Affinity")===-1) count++
                         return count;
                      },0)===0) hide++;
                    } else {
                      if (events[x].districts.split(",").reduce(function(count,dist) {return dist.toString().indexOf("HS")!==-1 ? ++count : count},0)===0) hide++;
                    }
                  } /*else if ((key==="grade" && filters[key]==="(K-5)") || (key==="grade" && filters[key]==="(K-8)") || (key==="grade" && filters[key]==="(K-5)") || key==="grade" && filters[key]==="(6-12)" ||(key==="grade" && filters[key]==="(K-12)")) {
                    
                  }*/ else {
                    if (events[x][key].toString().toUpperCase().indexOf(filters[key].toString().toUpperCase()) === -1) hide++
                  }
                }
                if (filters.has_registrants!=="") {
                    if (events[x].currentRegs==="" || events[x].currentRegs===0) hide++;
                }
                if (filters.date!=="") {
                  if (events[x].allDates.indexOf(filters.date)===-1) hide++;
                }
                return hide;
              },0) === 0) {
                // At this point we know that the event passed through all of the filters except District Attending and DBN attending. Now, we'll check those.
                var event = copyObject(events[x]);
                if (filters.districts_attending==="" && filters.dbn_attending==="") {
                  filteredEvents.push(event);
                } else {
                  // if EITHER the district filter or the dbn filter is selected and the event doesn't contain any registrants from either that district or that dbn, then skip to the next event
                  if (!event.districts_attending) {continue}
                  var districtsAttending = event.districts_attending.split(",")
                  if ((districtsAttending.indexOf(filters.districts_attending)===-1 && filters.districts_attending!=="") ||
                      (event.dbns_attending.indexOf(filters.dbn_attending)===-1 && filters.dbn_attending!=="")) {
                        continue;
                      }
                  // Now we know that either the district filter or dbn filter was selected and that this event has attendees from the district or the dbn
                      // so first reset all of the attendance info since it will need to be recalculated depending on how many ppl from the desired district/dbn came
                      event.attendanceInfo.registered=0;
                      event.attendanceInfo.attended=0;
                      event.attendanceInfo.regRate=0;
                      event.attendanceInfo.sessions_attended=0;
                      event.attendanceInfo.attended1day=0;
                      var districtRegs = 0;
                  // If ONLY district filter was selected...
                  if (filters.districts_attending!=="" && filters.dbn_attending==="") {
                      for (var i=event.attendanceInfo.dbns.length-1; i>=0; i--) {
                        if (event.attendanceInfo.dbns[i].district.toString()!==filters.districts_attending.toString()) {
                            //event.attendanceInfo.attended1day=event.attended1day-event.attendanceInfo.dbns[i].attended;
                            console.log("splicing ",event.attendanceInfo.dbns[i]," for event "+event.id);
                            event.attendanceInfo.dbns.splice(i,1);
                        } else {
                          if (event.attendanceInfo.dbns[i].sessions_attended || event.attendanceInfo.dbns[i].sessions_attended===0) {
                            event.attendanceInfo.sessions_attended+=event.attendanceInfo.dbns[i].sessions_attended;
                          } else {
                            event.attendanceInfo.sessions_attended+=event.attendanceInfo.dbns[i].attended;
                          }
                          event.attendanceInfo.attended1day+=event.attendanceInfo.dbns[i].attended;
                          event.attendanceInfo.regRate+=event.attendanceInfo.dbns[i].registered_sessions;
                          event.attendanceInfo.registered+=event.attendanceInfo.dbns[i].registered;
                          districtRegs+=event.attendanceInfo.dbns[i].registered;
                        }
                      }
                      event.max_regs = event.currentRegs;
                      event.currentRegs = districtRegs;
                      event.attendanceInfo.attendanceRate=event.attendanceInfo.sessions_attended/event.attendanceInfo.regRate;
                      filteredEvents.push(event);
                  } // If the DBN filter was selected
                    else if (filters.dbn_attending!=="") {
                      for (var i=event.attendanceInfo.dbns.length-1; i>=0; i--) {
                        if (event.attendanceInfo.dbns[i].dbn!==filters.dbn_attending) {
                          //event.attendanceInfo.attended1day=event.attended1day-event.attendanceInfo.dbns[i].attended;
                          event.attendanceInfo.dbns.splice(i,1);                       
                        } else {
                          if (event.attendanceInfo.dbns[i].sessions_attended || event.attendanceInfo.dbns[i].sessions_attended===0) {
                            event.attendanceInfo.sessions_attended+=event.attendanceInfo.dbns[i].sessions_attended;
                          } else {
                            event.attendanceInfo.sessions_attended+=event.attendanceInfo.dbns[i].attended;
                          }
                          event.attendanceInfo.attended1day+=event.attendanceInfo.dbns[i].attended;
                          event.attendanceInfo.regRate+=event.attendanceInfo.dbns[i].registered_sessions;
                          event.attendanceInfo.registered+=event.attendanceInfo.dbns[i].registered;
                          districtRegs+=event.attendanceInfo.dbns[i].registered;
                        }
                      }
                      event.max_regs = event.currentRegs;
                      event.currentRegs = districtRegs;
                      event.attendanceInfo.attendanceRate=event.attendanceInfo.sessions_attended/event.attendanceInfo.regRate;
                      filteredEvents.push(event);                      
                }     
                }
            }
          }
          renderEvents(JSON.stringify({"districts": allEventData.districts, "events": filteredEvents}),true);
        }
      }
      
      function copyArray(arr,newarr) {
        if (!newarr) {newarr=[]}
        if (!arr[0]) {return newarr}
        if (Array.isArray(arr[0])) {
          newarr.push(copyArray(arr[0],[]))
        } else if (typeof arr[0]==="object" && arr[0]!==null && Object.keys(arr[0]).length>0) {
          newarr.push(copyObject(arr[0],Object.keys(arr[0]),{}))
        } else {
          newarr.push(arr[0]);
        }
        return copyArray(arr.slice(1,arr.length),newarr);
      }

      function copyObject(obj,keys,newobj) {
        if (!keys) {keys=Object.keys(obj)}
        if (!newobj) {newobj={}}
        if (!keys[0]) {return newobj}
        if (Array.isArray(obj[keys[0]])) {
         if (keys[0]!=="attendance") {
            newobj[keys[0]]=copyArray(obj[keys[0]],[]);
          } else {
            newobj[keys[0]]=obj[keys[0]].slice(0);
          }
        } else if (typeof obj[keys[0]]==="object" && obj[keys[0]]!==null && Object.keys(obj[keys[0]]).length>0) {
          newobj[keys[0]]=copyObject(obj[keys[0]],Object.keys(obj[keys[0]]),{});
        } else {
          newobj[keys[0]] = obj[keys[0]];
        }
        return copyObject(obj,keys.slice(1,keys.length),newobj);
      }
      
      
//////// Archive Event Functions ////////////////////////////////       
       function createDbnTable(data) {
         console.log(data);
         var parent = htmlElement({tag: "div", className: 'dbn-table-container', id: "dbn-table-container-"+data.id, style: "width: 100%; display: flex; padding-bottom: 15px;"})
         var table = htmlElement({tag: "div", className: "dbn-table", style: "display: flex; width: 84%; justify-content: space-around;"});
         //create the first three (static) columns
         var col1 = htmlElement({tag: "div", className: "dbn-table-column"});
         col1.appendChild(htmlElement({tag: "div", innerHTML: "Session #", className: "header"}));
         col1.appendChild(htmlElement({tag: "div", innerHTML: "DBN", className: "header"}));
         var col2 = htmlElement({tag: "div", className: "dbn-table-column"});
         col2.appendChild(htmlElement({tag:"div",innerHTML:"All",className: "header"}));
         col2.appendChild(htmlElement({tag: "div", innerHTML: "Registered", className: "header"}));
         var col3 = htmlElement({tag: "div", className: "dbn-table-column"});
         col3.appendChild(htmlElement({tag:"div",innerHTML:"All",className: "header"}));
         col3.appendChild(htmlElement({tag: "div", innerHTML: "Attendance %", className: "header"}));
         var dbns = data.attendanceInfo.dbns;
         for (var i=0; i<dbns.length; i++) {
           col1.appendChild(htmlElement({tag: "div", innerHTML: dbns[i].dbn}));
           col2.appendChild(htmlElement({tag: "div", innerHTML: dbns[i].registered}));
           col3.appendChild(htmlElement({tag: "div", innerHTML: Number(Number(dbns[i].atRate)*100).toFixed(0)+"%"}));
         }
         table.appendChild(col1);
         table.appendChild(col2);
         table.appendChild(col3);
         parent.appendChild(table);
         // create the raw attendance number columns. Each col after the first has a width of 0, so won't display
         for (var j=1; j<=data.countDates;j++) {
           if (j===1) {
             var col = htmlElement({tag: "div", className: "dbn-table-column displayed-attn-col", id: "attn-col-"+data.id+"-"+j});
           } else {
             var col = htmlElement({tag: "div", className: "dbn-table-column overflow", id: "attn-col-"+data.id+"-"+j});
           }
           col.appendChild(htmlElement({tag: "div", innerHTML: j, className: "header"}));
           col.appendChild(htmlElement({tag: "div", innerHTML: "Attended", className: "header"}));
           for (var k=0;k<dbns.length;k++) {
             col.appendChild(htmlElement({tag: "div", innerHTML: dbns[k].attendance[Number(j)-1]}));
           }
           table.appendChild(col);
         }
         // create the arrow to display the next raw attn col, if available
         var arrowContainer = htmlElement({tag: "div", className: "arrow-container", style: "display: flex; width: 15%; justify-content: space-between; align-items: center;"});
         var arrowFunction = displayArrowFunction(data.countDates,data.eventId);
         arrowContainer.appendChild(htmlElement({tag: "div", className: "triangle-left triangle", id: "triangle-left-"+data.id, onclick: function(e) {arrowFunction(e.target)}, "data-eventid": data.id, "data-countdates": data.countDates}));
         if (data.countDates>1) {
           arrowContainer.appendChild(htmlElement({tag: "div", className: "triangle-right-active", id:"triangle-right-"+data.id, onclick: function(e) {arrowFunction(e.target)}, "data-eventid": data.id, "data-countdates": data.countDates}));
         } else {
           arrowContainer.appendChild(htmlElement({tag: "div", className: "triangle-right", id:"triangle-right-"+data.id, onclick: function(e) {arrowFunction(e.target)}, "data-eventid": data.id, "data-countdates": data.countDates}));
         }
         parent.appendChild(arrowContainer);
         console.log("dbn table ",parent);
         return parent;
      }


    function htmlElement(obj,parent) {
    if (obj.tag) {
      var element = document.createElement(obj.tag);
    } else {
      var element = document.createElement("DIV");
    }
    var keys = Object.keys(obj);
    keys.forEach(function(key) {
      if (key==="tag") {return}
      if (key.indexOf("data-")!==-1) {
        element.setAttribute(key,obj[key])
      } else if (key==="eventListener") {
        element.addEventListener(obj[key].event, obj[key].function)
      }
      else {element[key]=obj[key]}
    });
    if (parent) {
      parent.appendChild(element);
    } else {
      return element;
    }
  }

      var displayArrowFunction = function(countDates,eventId) {
        var currentCol = 1;
        return function(button) {
          // if the button is greyed out
          if (button.className.indexOf("active")===-1) {return;}
          // If the button isn't greyed out
          document.getElementById("attn-col-"+button.dataset.eventid+"-"+currentCol).className="dbn-table-column overflow";
          // if this is the next button
          if (button.className==="triangle-right-active") {
            currentCol++;
            document.getElementById("attn-col-"+button.dataset.eventid+"-"+currentCol).className="dbn-table-column displayed-attn-col";
            document.getElementById("triangle-left-"+button.dataset.eventid).className = "triangle-left-active";
            if (currentCol.toString()===button.dataset.countdates.toString()) {
              button.className = "triangle-right";
            }
          }
          // if this is the prev button
          else if (button.className==="triangle-left-active") {
            currentCol--;
            document.getElementById("attn-col-"+button.dataset.eventid+"-"+currentCol).className="dbn-table-column displayed-attn-col";
            document.getElementById("triangle-right-"+button.dataset.eventid).className = "triangle-right-active";
            if (currentCol===1) {
              button.className="triangle-left";
            }
        }
        }
      }
      
      function showDbnTable(buttonElement,eventid) {
         //var eventIndex = archiveEventData.event_id_indexes.indexOf(buttonElement.dataset.id);
         if (filters.districts_attending==="" && filters.dbn_attending==="") {
           var event = allEventData.events.filter(function(el) {return el.id===eventid})[0];
         } else {
           var event = filteredEvents.filter(function(el) {return el.id===eventid})[0];
         }
         var dbnContainer = document.getElementById("dbn-container-"+eventid);
         if (dbnContainer.style.display==="none") {
           console.log("dbn container not displayed");
           dbnContainer.style.display="flex";
           console.log(event);
           console.log(document.getElementById("dbn-container-"+eventid));
           if (!document.getElementById("dbn-table-container-"+eventid)) {
             console.log("creating a new dbn table");
             dbnContainer.appendChild(createDbnTable(event));
           }
           buttonElement.innerHTML = "Hide Attendance Table";
         } else {
           dbnContainer.style.display = "none";
           buttonElement.innerHTML = "Show Attendance Table";
         }
      }
      
      function copyEvent(eventId) {
        document.getElementById("event-details").style.visibility="hidden"
        document.getElementById("main-spinner").style.display=""
        document.getElementById("main-spinner-msg").innerHTML="Copying your event. Please wait for confirmation"
        var withSuccess = google.script.run.withSuccessHandler(function() {
          document.getElementById("spinner-loader").style.visibility="hidden";
          document.getElementById("main-spinner-msg").innerHTML="<div class='alert alert-success' role='alert'>A duplicate event was created. You need to refresh the page to view it.</div><br><button class='btn btn-secondary' onclick='restore()'>OK</button>";
        });
        var withFailure = withSuccess.withFailureHandler(function(error) {
          document.getElementById("spinner-loader").style.visibility="hidden";
          document.getElementById("main-spinner-msg").innerHTML="<span class='badge badge-dark' style='margin-right: 25px;'>Duplication failed.</span><button class='btn btn-secondary' onclick='restore()'>OK</button>";
          console.log(error);
        });
        withFailure.duplicateEvent(eventId,instance);
      }
      
      function setContent(el) {
        document.getElementById("content").setAttribute("value",el.innerHTML);
        document.getElementById("content").value=el.innerHTML;
        console.log(document.getElementById("content").value);
        filterTable(document.getElementById("content"));
      }
      
      function filterContentList(el) {
        var contentList = document.getElementById("content-list");
        if (el.value==="") {
          filterTable(el);
          setTimeout(function() {contentList.style.display="none"},350)
        }
        var items = contentList.getElementsByTagName("LI");
        console.log("element value = "+el.value);
        for (var i=0; i<items.length; i++) {
          if (el.value==="" || items[i].innerHTML.toLowerCase().indexOf(el.value.toLowerCase())!==-1) {
            items[i].style.display="";
          } else if (items[i].innerHTML.toLowerCase().indexOf(el.value.toLowerCase())===-1) {
            items[i].style.display="none";
          }
        }
      }
      
      function displaySelectBcos() {
        document.getElementById("modal-title").innerHTML="Administrator Portal";
        document.getElementById("modal-body-msg").style.display = "flex";
        document.getElementById("modal-success").style.display = "none";
        document.getElementById("modal-failure").style.display = "none";
        bcos = [];
        document.getElementById("modal-body-msg").innerHTML='<p><b>To get started, select the borough or citywide offices for which you want to view data</b></p>\
            <ul class="list-group" style="width: 100%;">\
              <li class="list-group-item" id="Affinity PL System" onclick="selectBco(this)">Affinity</li>\
              <li class="list-group-item" id="Bronx PL System" onclick="selectBco(this)">Bronx</li>\
              <li class="list-group-item" id="Brooklyn North PL System" onclick="selectBco(this)">Brooklyn North</li>\
              <li class="list-group-item" id="Brooklyn South PL System" onclick="selectBco(this)">Brooklyn South</li>\
              <li class="list-group-item" id="Manhattan PL System" onclick="selectBco(this)">Manhattan</li>\
              <li class="list-group-item" id="Central PL System" onclick="selectBco(this)">OFDC</li>\
              <li class="list-group-item" id="Queens North PL System" onclick="selectBco(this)">Queens North</li>\
              <li class="list-group-item" id="Queens South PL System" onclick="selectBco(this)">Queens South</li>\
              <li class="list-group-item" id="Staten Island PL System" onclick="selectBco(this)">Staten Island</li>\
            </ul>\
            <div id="sy-select-container" style="margin: 15px 0 15px 0;">\
              <label for="sy-select">Select The year for which you want to view data</label>\
              <select class="form-control" id="sy-select" name="sy-select" oninput="selectSy(this)">\
              </select>\
            </div>\
            <button type="button" class="btn btn-primary" style="margin-top: 15px;" onclick="fetchInstanceDetails()" data-dismiss="modal">Get Data</button>';
            displaySys();
      }
      
      function displaySys() {
        var years = document.getElementById("sy-select").getElementsByTagName("OPTION");
        var today = new Date();
        var curYear = today.getFullYear();
        if ((today.getMonth()>=8 && today.getDate()>=7) || today.getMonth()>=9) curYear++;
          var yearsSince18 = curYear-2018;
        for (var i=yearsSince18; i>0; i--) {
          var curSy = "SY"+Number(curYear-i).toString().slice(2,4)+"-"+Number(curYear-i+1).toString().slice(2,4);
          if (i===1) {
            document.getElementById("sy-select").appendChild(htmlElement({tag: "OPTION", value: "current", innerHTML: curSy, selected: true}));
          } else {
            document.getElementById("sy-select").appendChild(htmlElement({tag: "OPTION", value: curSy, innerHTML: curSy}));
          }
        }
      }
      
      function fetchDbnDetails() {
        var dbn = document.getElementById("dbn-input").value;
        var bcos = [];
        var options = document.getElementById("bco-input").getElementsByTagName("OPTION");
        for (var i=0; i<options.length; i++) {
          if (options[i].selected) {
            bcos.push(options[i].value);
          }
        }
        if (dbn.length<6 || bcos.length<1) {alert("You must enter a valid DBN and select at least one borough office."); return}
        document.getElementById("dbn-supports-container").innerHTML = "";
        document.getElementById("modal-success").style.display = "none";
        document.getElementById("modal-failure").style.display = "none";
        document.getElementById("modal-body-msg").style.display = "";
        document.getElementById("dbn-lookup-form").style.display= "none";
        document.getElementById("dbn-spinner").style.display = "";
        document.getElementById("dbn-spinner-msg").innerHTML = "Retreiving data for "+dbn+"."
        var withSuccess = google.script.run.withSuccessHandler(function(callback) {
          document.getElementById("dbn-spinner").style.display = "none";
          document.getElementById("dbn-lookup-form").style.display= "";
          document.getElementById("dbn-supports-container").innerHTML=callback.length;
        });
        var withFailure = withSuccess.withFailureHandler(function(error) {
          document.getElementById("dbn-spinner").style.display = "none";
          document.getElementById("dbn-lookup-form").style.display= "";
          document.getElementById("dbn-supports-container").innerHTML = '<div class="alert alert-danger" role="alert">'+error+'</div>';
        });
        withFailure.getDbnSupport(dbn,bcos);        
      }
      
function listDbns(input) {
  item("dbn-list").innerHTML = "";
  item("dbn-list").style.display = "";
  if (input==="") {filterTable(item("dbn_attending")); return}
  var newDiv;
  dbns.all.forEach(function(dbn) {
    if (dbn.toUpperCase().indexOf(input.trim().toUpperCase())!==-1) {
      newDiv = document.createElement("div");
      newDiv.innerHTML = dbn;
      newDiv.className="dbn-select";
      newDiv.onmousedown = function() {
        item("dbn_attending").value=dbn;
        filterTable(item("dbn_attending"));
      }
      newDiv.onmouseup = function() {item("dbn-list").style.display = "none";}
      item("dbn-list").appendChild(newDiv);
    }
  });
  if (input!=="" && document.getElementById("dbn-list").children.length<1) {
      wildcards.forEach(function(w) {
       newDiv = document.createElement("div");
       newDiv.innerHTML = w;
       newDiv.className="dbn-select";
       newDiv.style.fontSize = "11px";
        newDiv.onmousedown = function() {
          document.getElementById("dbn_attending").value=w;
          filterTable(item("dbn_attending"));
        }
        newDiv.onmouseup = function() {
          document.getElementById("dbn-list").style.display = "none";
        }
        item("dbn-list").appendChild(newDiv);       
      });  
  }
}

function hideDbns() {setTimeout(function() {item("dbn-list").style.display="none";},100)}

function item(element) {return document.getElementById(element);}

var dbns = [];
var wildcards = ['AF-Affinity Citywide Office','BX-Bronx Borough Office','KN-Brooklyn North Borough Office','KS-Brooklyn South Borough Office','MN-Manhattan Borough Office','QN-Queens North Borough Office','QS-Queens South Borough Office','SI-Staten Island Borough Office','Central Office','District Office','Non DOE','Other'];

      function fetchDbns() {
      //support for Microsoft
        var withSuccess = google.script.run.withSuccessHandler(function(msg) {
          console.log("dbns = ",msg);
          dbns = msg;
        });
        var withFailure = withSuccess.withFailureHandler(function(error) { console.log(error)});
        withFailure.getDbns();
      }
      
      function toggleMoreFilters(btn) {
        if (btn.dataset.expanded==="false") {
          btn.innerHTML = "Hide Filters";
          btn.dataset.expanded="true";
          document.getElementById("more-filters").style.display="";
        } else {
          btn.innerHTML = "More Filters";
          btn.dataset.expanded="false";
          document.getElementById("more-filters").style.display="none";          
        }
      }
</script>